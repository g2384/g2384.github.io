<html>
<style>body{font-size:16px;font-family: consolas;}.r{color:red;}
textarea {
	width: 600px;
	height: 120px;
	padding: 5px;
	font-size:16px;
}
input[type='text']{
margin: 5px 5px;
padding: 5px 8px;
line-height: 1.33;
width:50px;
}
.btn{
margin: 10px 10px;
padding: 5px 8px;
font-size: 16px;
line-height: 1.33;
border-radius: 3px;
color: #333;
background-color: #fff;
cursor: pointer;
text-align: center;
white-space: nowrap;
border: 1px solid rgb(194, 194, 194);}
.btn:hover{color:red;}</style>
<script>
function solveSudoku(r){var a=(new Date).getTime(),e=parseSudoku(r);if(0==e)return"Board does not contain enough numbers";for(var o=[9],l=0;9>l;l++){o[l]=[9];for(var t=0;9>t;t++)o[l][t]=allAllowed}for(var i=0,l=0;9>l;l++)for(var t=0;9>t;t++)e[l][t]>0&&(o[l][t]=0,applyAllowedValuesMask(e,o,l,t),i++);i=applyRulesSudoku(e,o,i);for(var f="",l=0;9>l;l++){(3==l||6==l)&&(f+="\n");for(var t=0;9>t;t++)(3==t||6==t)&&(f+=" "),f+=e[l][t];f+="\n"}return f+=i>=81?"success "+((new Date).getTime()-a)+"ms":"failure "+((new Date).getTime()-a)+"ms"}function applyRulesSudoku(r,a,e){for(var o=0;e-o>3&&68>e&&e>10;)o=e,e+=moveNothingElseAllowed(r,a),e+=moveNoOtherRowOrColumnAllowed(r,a),e+=moveNothingElseAllowed(r,a),35>e&&(applyNakedPairs(r,a),applyLineCandidatevarraints(r,a));if(81>e){var l=attemptBruteForce(r,a,e);if(null!=l){e=0;for(var t=0;9>t;t++)for(var i=0;9>i;i++)r[t][i]=l[t][i],l[t][i]>0&&e++}}return e}function attemptBruteForce(r,a,e){for(var o=0;9>o;o++)for(var l=a[o],t=r[o],i=0;9>i;i++)if(0==t[i]){for(var f=1;9>=f;f++)if((l[i]&allowedBitFields[f])>0){var v=copyGameMatrix(r),s=copyGameMatrix(a);setValue(v,s,f,o,i);var n=applyRulesSudoku(v,s,e+1);if(81==n)return v}return null}return null}function moveNoOtherRowOrColumnAllowed(r,a){for(var e=0,o=1;9>=o;o++){for(var l=allowedBitFields[o],t=0;9>t;t++){for(var i=-1,f=a[t],v=0;9>v;v++)if((f[v]&l)>0){if(!(0>i)){i=-1;break}i=v}i>=0&&(setValue(r,a,o,t,i),e++)}for(var v=0;9>v;v++){for(var s=-1,t=0;9>t;t++)if((a[t][v]&l)>0){if(!(0>s)){s=-1;break}s=t}s>=0&&(setValue(r,a,o,s,v),e++)}}return e}function moveNothingElseAllowed(r,a){for(var e=0,o=0;9>o;o++)for(var l=a[o],t=0;9>t;t++){var i=l[t];1==countSetBits(i)&&(setValue(r,a,getLastSetBitIndex(i),o,t),e++)}return e}function applyNakedPairs(r,a){for(var e=0;9>e;e++)for(var o=0;9>o;o++){var l=a[e][o];if(2==countSetBits(l))for(var t=o+1;9>t;t++)if(a[e][t]==l)for(var i=~l,f=0;9>f;f++)f!=o&&f!=t&&(a[e][f]&=i)}for(var o=0;9>o;o++)for(var e=0;9>e;e++){var v=a[e][o];if(0!=v&&2==countSetBits(v))for(var s=e+1;9>s;s++)if(a[s][o]==v)for(var n=~v,u=0;9>u;u++)u!=e&&u!=s&&(a[u][o]&=n)}}function applyLineCandidatevarraints(r,a){for(var e=1;9>=e;e++){for(var o=allowedBitFields[e],l=~o,t=[9],i=0;9>i;i++){for(var f=i,v=0;9>v;v++)0!=(a[f][v]&o)&&(t[f]|=1<<v/3);if(2==f||5==f||8==f)for(var s=f-2;f>=s;s++){var n=countSetBits(t[s]);if(1==n)for(var u=f-2;f>=u;u++)if(s!=u)for(var d=0;3>d;d++)if(0!=(t[s]&1<<d))for(var c=3*d;3*(d+1)>c;c++)a[u][c]&=l;if(2==n&&f>s)for(var w=s+1;f>=w;w++)if(t[s]==t[w]){var u;u=w!=f?f:w-s>1?w-1:s-1;for(var d=0;3>d;d++)if(0!=(t[s]&1<<d))for(var c=3*d;3*(d+1)>c;c++)a[u][c]&=l;break}}}for(var k=[9],v=0;9>v;v++){for(var p=v,i=0;9>i;i++)0!=(a[i][p]&o)&&(k[p]|=1<<i/3);if(2==p||5==p||8==p)for(var B=p-2;p>=B;B++){var b=countSetBits(k[B]);if(1==b)for(var c=p-2;p>=c;c++)if(B!=c)for(var m=0;3>m;m++)if(0!=(k[B]&1<<m))for(var u=3*m;3*(m+1)>u;u++)a[u][c]&=l;if(2==b&&p>B)for(var F=B+1;p>=F;F++)if(k[B]==k[F]){var c;c=F!=p?p:F-B>1?F-1:B-1;for(var m=0;3>m;m++)if(0!=(k[B]&1<<m))for(var u=3*m;3*(m+1)>u;u++)a[u][c]&=l}}}}}function applyAllowedValuesMask(r,a,e,o){for(var l=~allowedBitFields[r[e][o]],t=0;9>t;t++)a[t][o]&=l;for(var i=a[e],f=0;9>f;f++)i[f]&=l;var v=0,s=0;switch(e){case 0:v=e+1,s=e+2;break;case 1:v=e-1,s=e+1;break;case 2:v=e-2,s=e-1;break;case 3:v=e+1,s=e+2;break;case 4:v=e-1,s=e+1;break;case 5:v=e-2,s=e-1;break;case 6:v=e+1,s=e+2;break;case 7:v=e-1,s=e+1;break;case 8:v=e-2,s=e-1}var n=0,u=0;switch(o){case 0:n=o+1,u=o+2;break;case 1:n=o-1,u=o+1;break;case 2:n=o-2,u=o-1;break;case 3:n=o+1,u=o+2;break;case 4:n=o-1,u=o+1;break;case 5:n=o-2,u=o-1;break;case 6:n=o+1,u=o+2;break;case 7:n=o-1,u=o+1;break;case 8:n=o-2,u=o-1}var d=a[v],c=a[s];d[n]&=l,d[u]&=l,c[n]&=l,c[u]&=l}function setValue(r,a,e,o,l){r[o][l]=e,a[o][l]=0,applyAllowedValuesMask(r,a,o,l)}function getLastSetBitIndex(r){for(var a=0;r>0;)a++,r>>=1;return a}function countSetBits(r){for(var a=0;r>0;)r&=r-1,a++;return a}function copyGameMatrix(r){for(var a=[r.length],e=0;e<r.length;e++)a[e]=r[e].slice(0);return a}function parseSudoku(r){for(var a=[9],e=0;9>e;e++)a[e]=[9];for(var o=0,e=0;e<r.length&&81>o;e++){var l=r.charAt(e);"9">=l&&l>="0"&&(a[Math.floor(o/9)][o%9]=l,o++)}return o>=81?a:0}var allowedBitFields=[10];allowedBitFields[0]=0,allowedBitFields[1]=1,allowedBitFields[2]=2,allowedBitFields[3]=4,allowedBitFields[4]=8,allowedBitFields[5]=16,allowedBitFields[6]=32,allowedBitFields[7]=64,allowedBitFields[8]=128,allowedBitFields[9]=256;var allAllowed=511;


var block = [
[[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2], [2, 0], [2, 1], [2, 2]],
[[3, 0], [3, 1], [3, 2], [4, 0], [4, 1], [4, 2], [5, 0], [5, 1], [5, 2]],
[[6, 0], [6, 1], [6, 2], [7, 0], [7, 1], [7, 2], [8, 0], [8, 1], [8, 2]],
[[0, 3], [0, 4], [0, 5], [1, 3], [1, 4], [1, 5], [2, 3], [2, 4], [2, 5]],
[[3, 3], [3, 4], [3, 5], [4, 3], [4, 4], [4, 5], [5, 3], [5, 4], [5, 5]],
[[6, 3], [6, 4], [6, 5], [7, 3], [7, 4], [7, 5], [8, 3], [8, 4], [8, 5]],
[[0, 6], [0, 7], [0, 8], [1, 6], [1, 7], [1, 8], [2, 6], [2, 7], [2, 8]],
[[3, 6], [3, 7], [3, 8], [4, 6], [4, 7], [4, 8], [5, 6], [5, 7], [5, 8]],
[[6, 6], [6, 7], [6, 8], [7, 6], [7, 7], [7, 8], [8, 6], [8, 7], [8, 8]],
];
var column = [[1, 2],[0, 2],[0, 1],[4, 5],[3, 5],[3, 4],[7, 8],[6, 8],[6, 7]]
var candidates = [9];
var candidatesJoin = [9];
var removings_blockRowColumn = '';
var removings_doublePairs = '';
var removings_nakedPairs = '';

function solve() {
var s=document.getElementById('in').value;
var u=document.getElementById('u').value;
var re = new RegExp(u, "g");
if(u!=0){
s=s.replace(re,'0');
}
s=s.replace(/[^0-9]+/g,'')
    var str = solveSudoku(s);
    var str2 = solveSudokuStepByStep(s, str);
    document.getElementById('out').innerHTML = str2.replace(/\n/g, '<br>') + '-----------<br>Correct answer: <br><br>' + str.replace(/\n/g, '<br>') + '<br>';
}

function solveSudokuStepByStep(puzzleText, corr) {
    removings_blockRowColumn = '';
    removings_doublePairs = '';
    removings_nakedPairs = '';
    var board = parseSudoku(puzzleText);
    if (board == 0) {
        return "Board does not contain enough numbers";
    } else {
        for (var x = 0; x < 9; x++) {
            candidates[x] = [9];
            candidatesJoin[x] = [9];
            for (var y = 0; y < 9; y++) {
                candidates[x][y] = ["1", "2", "3", "4", "5", "6", "7", "8", "9"];
                candidatesJoin[x][y] = '';
            }
        }
        for (var x = 0; x < 9; x++) {
            for (var y = 0; y < 9; y++) {
                if (board[x][y] > 0) {
                    RefineCandidates(board, candidates, x, y);
                }
            }
        }
        var solution = '<strong>input:</strong> <br>' + printBoard(board, 9, []);
        var num = '.';
        var step = 0;
        //console.log(candidatesJoin)
        while (num != '' && step < 30) { // solve by using easy methods first
            //console.log(printcandidates(candidates))
            for (i = 0; i < 9; i++) {
                //console.log(candidatesJoin[i].join('; '))
            }
            var o = false;
            num = SoleCandidate(board, candidates);
            if (num != '') {
                step++;
                solution += parseResult(num, board, step)
                o = true
            }
			
			for (i = 0; i < 9; i++) {
                //console.log(candidatesJoin[i].join('; '))
            }
			
            num = UniqueCandidate(board, candidates);
            if (num != '') {
                step++;
                solution += parseResult(num, board, step)
                o = true
            }
			if(o){
			num='.'
			}else
            if (o == false) {

                var new_ = false;
                num = blockRowColumn(board, candidates);
                //console.log(num)
                //console.log('blockRowColumn', num, step)
                if (num != '') {
                    step++;
                    solution += parseResult(num, board, step + ' Column/Row Interaction')
                    new_ = true;
                }
                num = doublePairs(board, candidates)
                if (num != '') {
                    //console.log('doublePairs',num)
                    step++;
                    solution += parseResult(num, board, step + ' Double Pairs')
                    new_ = true;
                }
                num = NakedPair_new(board, candidates)
                    //num = ''
                if (num != '') {
                    //console.log('NakedPair',num)
                    step++;
                    solution += parseResult(num, board, step + ' Naked Pairs')
                    new_ = true;
                }

                if (new_) {
                    num = '.'
                }
            }
        }

        var final_r = printBoard(board, 9, []);
        var final_c = corr.replace(/[^0-9]/g, '');
        final_r = final_r.replace(/[^0-9]/g, '');
        f1 = final_c.split('')
        f2 = final_r.split('')
        var final_p = ''
        var wrong = false;
        for (var i = 0; i < 81; i++) {
            if (f1[i] != f2[i]&&f2[i]!=0) {
                f2[i] = '<span class="r">' + f2[i] + '</span>';
                wrong = true;
            }
            if (i > 0) {
                if (i % 9 == 0) {
                    final_p += '\n'
                } else if (i % 3 == 0) {
                    final_p += ' '
                }
                
            }
			final_p += f2[i]
        }
        if (wrong) {
            return solution + '\n\nSorry, got a wrong solution(wrong numbers are highlighted in red): \n' + final_p;
        } else {
            return solution;
        }
    }
}

function parseResult(num, board, step) {
    var solution = '<strong>step ' + step + ':</strong>\n';
    a = num.split('\n')
    var kk = [];
    //console.log('step: '+step)
    for (var k = 0; k < a.length - 1; k++) {
        var a2 = a[k].split(',')
        //console.log(a2[0].indexOf('cannot appear') >= 0)
        if (a2[0].indexOf('cannot appear') >= 0) {
            solution += logInfo(a2[1] + ' ' + a2[0], parseInt(a2[2]), a2[3], 0)
            //console.log(solution)
        } else if(a2[0].indexOf('can only appear')>=0 ){
		
			solution += a2[2] +' '+ a2[0] + a2[3] +' except for '+a2[4]+' '+ a2[1]+'<br>';
		}else if(a2[0].indexOf('naked pairs')>=0){
		solution += a2[0]+'<br>';
		}else if(a2[0].indexOf('naked triple')>=0){
		solution += a2[0]+'<br>';
		}else {

            kk.push([parseInt(a2[2]), parseInt(a2[3])])
            solution += logInfo(a2[0], a2[1], parseInt(a2[2]), parseInt(a2[3]))
        }
    }
    //console.log('kk',kk.join())
    solution += '\n'
    if (kk.length > 0) {
        unsorted = true;
        while (unsorted) {
            unsorted = false;
            for (var k = 0; k < kk.length - 1; k++) {
			if (kk[k][1] > kk[k + 1][1] && kk[k][0] == kk[k + 1][0]) {
                    var s = kk[k];
                    kk[k] = kk[k + 1];
                    kk[k + 1] = s;
                    unsorted = true;
               }else 
                if (kk[k][0] > kk[k + 1][0]) {
                    var s = kk[k];
                    kk[k] = kk[k + 1];
                    kk[k + 1] = s;
                    unsorted = true;
                }
            }
        }
        //console.log('kk',kk.join())

        solution += printBoard(board, 9, kk);
    }
    return solution
}

function printBoard(board, s, pos) {
    var solution = "";
    var ind = 0;
    var l = pos.length;
    if (l == 0) {
        ind = -1;
    }
    if (s == 9) {
        for (var x = 0; x < 9; x++) {
            if (x == 3 || x == 6) {
                solution += "\n";
            }
            for (var y = 0; y < 9; y++) {
                if (y == 3 || y == 6) {
                    solution += " ";
                }
                if (ind >= 0 && ind < l) {
                    if (pos[ind][0] == x && pos[ind][1] == y) {
                        solution += '<span class="r">' + board[x][y] + '</span>';
                        ind++;
                        //console.log(ind)
                    } else {
                        solution += board[x][y];
                    }
                } else {
                    solution += board[x][y];
                }
            }

            solution += "\n"
        }
    } else {
        for (var x = 0; x < 9; x++) {
            for (var y = 0; y < 9; y++) {
                solution += board[x][y];
            }
        }

    }
    return solution + '\n'
}

function printcandidates(candidates) {
    var s = ''
    for (var i = 0; i < 9; i++) {
        for (var j = 0; j < 9; j++) {
            var t = candidates[i][j].join('');
            if (t != '')
                s += (i + 1) + ' ' + (j + 1) + ' ' + t + '\n';
        }
    }
    return s
}

function RefineCandidates(board, candidates, x, y) {
    var n = board[x][y] - 1;
    candidates[x][y] = ["", "", "", "", "", "", "", "", ""];
    for (var i = 0; i < 9; i++) {
        candidates[x][i][n] = ""; // row
        candidates[i][y][n] = ""; // column
    }
	
    c = Math.floor(y / 3);
    r = Math.floor(x / 3);
	
    for (var i = 0; i < 3; i++) {
        for (var j = 0; j < 3; j++) {
            candidates[r * 3 + i][c * 3 + j][n] = "";
        }
    }

    for (var i = 0; i < 9; i++) {
        candidatesJoin[i][y] = candidates[i][y].join('');
        candidatesJoin[x][i] = candidates[x][i].join('');
    }
    for (var i = 0; i < 3; i++) {
        for (var j = 0; j < 3; j++) {
            candidatesJoin[r * 3 + i][c * 3 + j] = candidates[r * 3 + i][c * 3 + j].join('');
        }
    }
}

function FillValue(board, candidates, value, x, y) {
    board[x][y] = value;
    RefineCandidates(board, candidates, x, y);
}

function SoleCandidate(board, candidates) {
    var str = ''
    for (var x = 0; x < 9; x++) {
        for (var y = 0; y < 9; y++) {
            if (candidatesJoin[x][y].length == 1) {
                var value = Number(candidatesJoin[x][y])
                FillValue(board, candidates, value, x, y);
                str += 'Only candidate: ' + ',' + value + ',' + x + ',' + y + '\n'
            }
        }
    }
    return str;
}

function UniqueCandidate(board, candidates) {
    var str = '';

    for (var i = 0; i < 9; i++) {
        var s = ''
        var a = []
        for (var j = 0; j < 9; j++) {
            s += candidatesJoin[block[i][j][0]][block[i][j][1]];
        }
        for (var j = 1; j < 10; j++) {
            var re = new RegExp(j.toString(), "g");
            if (s.length == s.replace(re, '').length + 1) {
                a.push([j, i])
            }
        }
        for (var j = 0; j < a.length; j++) {
            var x = a[j][1]
            for (var y = 0; y < 9; y++) {
                //console.log(block[x][y][0],block[x][y][1])
                if (candidatesJoin[block[x][y][0]][block[x][y][1]].indexOf(a[j][0]) >= 0) {
                    FillValue(board, candidates, a[j][0], block[x][y][0], block[x][y][1]);
                    str += 'No other places allowed: ' + ',' + a[j][0] + ',' + block[x][y][0] + ',' + block[x][y][1] + '\n'
                }
            }
        }
    }

    return str;
}

function blockRowColumn(board, candidates) {
var str = '';
    for (var i = 0; i < 9; i++) {
        var s1 = '',
            s2 = '',
            s3 = '',
			s4 = '',
            s5 = '',
            s6 = '',
            s = '',
            
            j_a = [], j_a2 = [];
			j_ac=[block[i][0][1], block[i][1][1], block[i][2][1]];
			j_ar=[block[i][0][0], block[i][3][0], block[i][6][0]];
        //console.log('blockRowColumn', i)
        for (var j = 0; j < 3; j++) {
            var j2 = j * 3;
			var j3 = j+ 3*j;
            j_a.push(block[i][j2][0])
            //console.log('j_a', j_a, block[i][j2][0])
            s1 += candidatesJoin[block[i][j2][0]][block[i][0][1]];
            s2 += candidatesJoin[block[i][j2][0]][block[i][1][1]];
            s3 += candidatesJoin[block[i][j2][0]][block[i][2][1]];
			
			j_a2.push(block[i][j3][1])
			s4 += candidatesJoin[block[i][0][0]][block[i][j3][1]];
            s5 += candidatesJoin[block[i][3][0]][block[i][j3][1]];
            s6 += candidatesJoin[block[i][6][0]][block[i][j3][1]];
			
            //console.log(s4, block[i][0][0], block[i][j][1], '///', s5, block[i][3][0], block[i][j+3][1], '///', s6, block[i][6][0], block[i][j+6][1])
        }
        u_s1 = unique(s1);
        u_s2 = unique(s2);
        u_s3 = unique(s3);
        u_s4 = unique(s4);
        u_s5 = unique(s5);
        u_s6 = unique(s6);
        //console.log('blockRowColumn', 'unique str', u_s4, u_s5, u_s6)

        //console.log(a)
        
		str+=find_uniquestr(board, u_s1, u_s2, u_s3,j_a, '', j_ac, 'column', i)
		str+=find_uniquestr(board, u_s4, u_s5, u_s6,j_a2, '', j_ar, 'row', i)
    }
	//console.log(str)
    return str
}

function find_uniquestr(board, u_s1, u_s2, u_s3,j_a, str, j_ac, setting, i){
s=u_s1 + u_s2 + u_s3;
var a = [];
var b;
        for (var j = 1; j < 10; j++) {
            var re = new RegExp(j.toString(), "g");
            if (s.length == s.replace(re, '').length + 1) {
                a.push([j, i])
				//console.log('blockRowColumn:', j, i, s, setting)
            }
        }
		
		for (var j = 0; j < a.length; j++) {
            var x = a[j][1]
            var col = -1;
            if (u_s1.indexOf(a[j][0]) >= 0) {
                col = j_ac[0];
            } else if (u_s2.indexOf(a[j][0]) >= 0) {
                col = j_ac[1];
            } else if (u_s3.indexOf(a[j][0]) >= 0) {
                col = j_ac[2];
            }
			
            var j_a_str = j_a.join('/');
            var j_copy = j_a_str.split('/')
            var known = check(board, a[j][0], col, setting);
			//console.log('blockRowColumn', a[j][0], i, s, setting, col, known, j_a_str)
            if (col>=0) {
                if (known == false) {
                    b=RemovingCandidates(candidates, a[j][0]-1, col, j_a, setting);
					if(b==false){
						if(setting=='column'){
							for (var p = 0; p < 3; p++) {
								//console.log(j_copy.join(', '), col)
								if (candidatesJoin[j_copy[p]][col].indexOf(a[j][0]) < 0) {
									j_copy[p] = '';
								} else {
									j_copy[p]++;
								}

							}
						}else if(setting=='row'){
							for (var p = 0; p < 3; p++) {
								//console.log(j_copy.join(', '), col)
								if (candidatesJoin[col][j_copy[p]].indexOf(a[j][0]) < 0) {
									j_copy[p] = '';
								} else {
									j_copy[p]++;
								}

							}
						}
                    j_a_str = j_copy.join('/');
                    j_a_str = j_a_str.replace(/\/+/g, '/')
                    j_a_str = j_a_str.replace(/\/$/g, '')
                    j_a_str = j_a_str.replace(/^\//g, '')
					if(j_a_str.length>0){
						var s__='cannot appear at ' + setting + ' ,' + a[j][0] + ',' + col + ',' + j_a_str + '\n';
						//console.log(s__ + i, '\n'+str)
						//console.log(removings.indexOf(s__))
						if(removings_blockRowColumn.indexOf(s__)<0){
							str += s__;
							removings_blockRowColumn +=s__;
						}
					}
					}
                    
                }
            }
        }
		//console.log('return str', str)
		return str
}
function doublePairs(board, candidates) {
    //not finished, under test, only rows are considered
    var str = '';
    var arr = [[0, 1, 2, 3, 4, 5], [3, 4, 5, 6, 7, 8], [0, 1, 2, 6, 7, 8]]
    var arr2 = [[6, 7, 8], [0, 1, 2], [3, 4, 5]]
    for (i = 0; i < 9; i++) {
        //console.log(candidatesJoin[i].join('; '))
    }
    var s_c = [27],
        s_cc = [27],
        s_c2 = [27],
        s_cc_board = [27];
    var s_c_a_unique = [27];
    var s_c_a = [27],
        other_part = [27];
	//row
    for (var j = 0; j < 9; j++) {
        for (var i = 0; i < 3; i++) {
            var kk = j * 3 + i;
            s_c_a[kk] = '';
            s_c[kk] = '';
            s_c2[kk] = '';
            s_cc[kk] = '';
            s_cc_board[kk] = '';
            other_part[kk] = [];
            other_part[kk].push([column[j][0], arr2[i][0]]);
            other_part[kk].push([column[j][0], arr2[i][1]]);
            other_part[kk].push([column[j][0], arr2[i][2]]);
            other_part[kk].push([column[j][1], arr2[i][0]]);
            other_part[kk].push([column[j][1], arr2[i][1]]);
            other_part[kk].push([column[j][1], arr2[i][2]]);
            s_c_a[kk] += board[j][arr2[i][0]];
            s_c_a[kk] += board[j][arr2[i][1]];
            s_c_a[kk] += board[j][arr2[i][2]];
            for (var k = 0; k < 6; k++) {
                s_c[kk] += candidatesJoin[column[j][0]][arr[i][k]]; // column_1
                s_c2[kk] += candidatesJoin[column[j][1]][arr[i][k]]; // column_2
                s_cc[kk] += candidatesJoin[j][arr[i][k]]; // center
                s_cc_board[kk] += board[j][arr[i][k]]; // center, known
            }
        }
    }
    for (var j = 0; j < 27; j++) {
        s_c_a_unique[j] = unique(s_c_a[j])
    }
    for (var i = 0; i < 27; i++) {
        str += find_uniquestr_2(board, unique(s_c[i]), unique(s_c2[i]), unique(s_cc[i]), unique(s_cc_board[i]), s_c_a_unique[i], other_part[i], candidates, 'row', i)
    }
	
	//console.log('column')
	//column
	for (var j = 0; j < 9; j++) {
        for (var i = 0; i < 3; i++) {
            var kk = j * 3 + i;
            s_c_a[kk] = '';
            s_c[kk] = '';
            s_c2[kk] = '';
            s_cc[kk] = '';
            s_cc_board[kk] = '';
			other_part[kk] = [];
            other_part[kk].push([column[j][0], arr2[i][0]]);
            other_part[kk].push([column[j][0], arr2[i][1]]);
            other_part[kk].push([column[j][0], arr2[i][2]]);
            other_part[kk].push([column[j][1], arr2[i][0]]);
            other_part[kk].push([column[j][1], arr2[i][1]]);
            other_part[kk].push([column[j][1], arr2[i][2]]);
			//console.log(other_part[kk].join(' '))
            s_c_a[kk] += board[arr2[i][0]][j];
            s_c_a[kk] += board[arr2[i][1]][j];
            s_c_a[kk] += board[arr2[i][2]][j];
            for (var k = 0; k < 6; k++) {
                s_c[kk] += candidatesJoin[arr[i][k]][column[j][0]]; // column_1
                s_c2[kk] += candidatesJoin[arr[i][k]][column[j][1]]; // column_2
                s_cc[kk] += candidatesJoin[arr[i][k]][j]; // center
                s_cc_board[kk] += board[arr[i][k]][j]; // center, known
            }
        }
    }
    for (var j = 0; j < 27; j++) {
        s_c_a_unique[j] = unique(s_c_a[j])
    }
    for (var i = 0; i < 27; i++) {
        str += find_uniquestr_2(board, unique(s_c[i]), unique(s_c2[i]), unique(s_cc[i]), unique(s_cc_board[i]), s_c_a_unique[i], other_part[i], candidates, 'col', i)
    }
    return str
}

function find_uniquestr_2(board, u_s, u_s2, u_sc, u_sc_board, uni, other, candidates, setting, i) {
    var a = [];
    var s = u_s + u_s2;
    var str = ''
        //console.log(i, u_s, u_s2, setting, uni,u_sc)
    var uni__ = uni.toString();
    var arr = [other[0][1] + 1, other[1][1] + 1, other[2][1] + 1]
    for (var j = 1; j < 10; j++) {
        var j_s = j.toString();
        var re = new RegExp(j_s, "g");
        var b = true;
        if (uni__.indexOf(j_s) < 0 && u_sc_board.indexOf(j_s) < 0) {
            if (s.length == s.replace(re, '').length + 2 && u_sc.length == u_sc.replace(re, '').length) {
			if(setting=='row'){
                // if two columns has it, the other column does not have it.
                for (var k = 0; k < 6; k++) {
                    candidates[other[k][0]][other[k][1]][j - 1] = ''
                    candidatesJoin[other[k][0]][other[k][1]] = candidates[other[k][0]][other[k][1]].join('')
                }
                var row = Math.floor(i / 3);
                for (var k = 0; k < 3; k++) {
                    if (candidates[row][other[k][1]][j - 1] == '') {
                        arr[k] = ''
                    }
                }
                var arr_s = arr.join('/');
                arr_s = arr_s.replace(/\/+/g, '/')
                arr_s = arr_s.replace(/\/$/g, '')
                arr_s = arr_s.replace(/^\//g, '')

                var s__ = 'can only appear at ' + setting + ' ,' + arr_s + ',' + j + ',' + (row + 1) + ',column' + '\n';
                if (removings_doublePairs.indexOf(s__) < 0) {
                    str += s__;
                    removings_doublePairs += s__;
                }

			}
			if(setting=='col'){
			
			
			 // if two columns has it, the other column does not have it.
                for (var k = 0; k < 6; k++) {
				//console.log('col, other', other[k].join(','))
                    candidates[other[k][1]][other[k][0]][j - 1] = ''
                    candidatesJoin[other[k][1]][other[k][0]] = candidates[other[k][1]][other[k][0]].join('')
                }
                var row = Math.floor(i / 3);
                for (var k = 0; k < 3; k++) {
                    if (candidates[other[k][1]][row][j - 1] == '') {
                        arr[k] = ''
                    }
                }
                var arr_s = arr.join('/');
                arr_s = arr_s.replace(/\/+/g, '/')
                arr_s = arr_s.replace(/\/$/g, '')
                arr_s = arr_s.replace(/^\//g, '')

                var s__ = 'can only appear at ' + setting + ' ,' + arr_s + ',' + j + ',' + (row + 1) + ',row' + '\n';
                if (removings_doublePairs.indexOf(s__) < 0) {
                    str += s__;
                    removings_doublePairs += s__;
                }
			}
            }
        }
    }
    return str
}
function NakedPair(board, candidates) {
    //works for column and rows
    var b = false,
        b2 = false;
    var str = '';
    for (var i = 0; i < 9; i++) {
        b = false;
        b2 = false;
        var ss = '';
        var pos = -1;
        var removed = false;
        var ss2 = '';
        var pos2 = -1;
        var removed2 = false;
        for (var j = 0; j < 9; j++) {
            a = NakedPairs_fun(board, candidates, ss, pos, removed, b, str, i, j, 'row')
            ss = a[0]
            pos = a[1]
            removed = a[2]
            b = a[3]
            str = a[4]
        }
    }
    for (var i = 0; i < 9; i++) {
        b = false;
        b2 = false;
        var ss = '';
        var pos = -1;
        var removed = false;
        var ss2 = '';
        var pos2 = -1;
        var removed2 = false;
        for (var j = 0; j < 9; j++) {
            a = NakedPairs_fun(board, candidates, ss, pos, removed, b, str, j, i, 'column')
            ss = a[0]
            pos = a[1]
            removed = a[2]
            b = a[3]
            str = a[4]
        }
    }
    return str;
}

function NakedPairs_fun(board, candidates, ss, pos, removed, b, str, i, j, setting) {
    //console.log(i, j)
    //console.log(candidatesJoin[i][j])
    if (candidatesJoin[i][j].length == 2) {
        if (b) {
            if (ss == candidatesJoin[i][j]) {
                //console.log('found', candidatesJoin[i][j], ss, i, j, pos)
                var bb = ss.split('')
                bb[0]--;
                bb[1]--;
                if (setting == 'row') {
                    //console.log(candidatesJoin[i].join(''), ss)
                    if (unique(candidatesJoin[i].join('')) != ss) {
                        for (k = 0; k < 9; k++) {
                            if (k != pos && k != j) {
                                if (candidatesJoin[i][k].length > 0) {
                                    candidates[i][k][bb[0]] = '';
                                    candidates[i][k][bb[1]] = '';
                                    candidatesJoin[i][k] = candidates[i][k].join('')
                                   // console.log('remove', ss, candidatesJoin[i][k], i, k)

                                }
                            }
                        }

                        var s__ = 'naked pairs ' + ss + ' @ ' + setting + ' ' + (i + 1) + '\n';
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }
                    }
                } else if (setting = 'column') {
                    var s_t = ''
                    for (var k = 0; k < 9; k++) {
                        s_t += candidatesJoin[k][j];
                    }
                    //console.log('column', s_t,unique(s_t), ss,j, i, pos)
                    if (unique(s_t) != ss) {

                        for (k = 0; k < 9; k++) {
                            if (k != pos && k != i) {
                                if (candidatesJoin[k][j].length > 0) {
                                    candidates[k][j][bb[0]] = '';
                                    candidates[k][j][bb[1]] = '';
                                    candidatesJoin[k][j] = candidates[k][j].join('')
                                    //console.log('remove', ss, candidatesJoin[k][j],  k,j, pos, i)

                                }
                            }
                        }

                        var s__ = 'naked pairs ' + ss + ' @ ' + setting + ' ' + (j + 1) + '\n';

                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }
                    }
                }

                for (var g = 0; g < 9; g++) {
                   // console.log(candidatesJoin[g].join('; '))
                }
            }
        } else {
            ss = candidatesJoin[i][j];
           // console.log('NakedPair', setting, candidatesJoin[i][j], i, j)
            if (setting == 'row') {
                pos = j;
            } else if (setting == 'column') {
                pos = i;
            }
            b = true;
        }
    }
    return [ss, pos, removed, b, str];
}
function NakedPair_new(board, candidates){
var lib=[[0,0], [1,3], [2,6], [3,1], [4,4], [5,7], [6,2], [7,5], [8,8]]
var str=''
for (i = 0; i < 9; i++) {
                console.log(candidatesJoin[i].join('; '))
            }
	for(var i=0;i<9;i++){
	//row
		var e=[];
		var t=false;
		for(var j=0;j<9;j++){
			
			var c=candidatesJoin[lib[i][0]][j];
			var l=c.length;
			if(l<4){
				
				if(l==2){
					for(var k=0;k<e.length;k++){
					if(c==e[k][1]){
						var b=c.split('')
						for(var n=0;n<9;n++){
							if(board[lib[i][0]][n]==0){
							if(n!=e[k][0]&&n!=j){
								if(t==false){
									if(candidates[lib[i][0]][n][b[0]]!=''){
										t=true
									}else if(candidates[lib[i][0]][n][b[1]]!=''){
										t=true
									}
								}
									candidates[lib[i][0]][n][b[0]-1]='';
									candidates[lib[i][0]][n][b[1]-1]='';
									candidatesJoin[lib[i][0]][n]=candidates[lib[i][0]][n].join('');
								}
							}
						}
						if(t){
						var s__ = 'naked pairs ' + c + ' @ row ' + (lib[i][0] + 1) + '\n';
						//console.log(s__)
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }
						}
					}
					}
				}
				e.push([j,c])
			}
			
		}
		//row, triple:
		if(t==false){
		for(var j=0;j<e.length;j++){
			if(e[j][1].length==3){
			var a=e[j][1].split('');
			var b=[a[0]+a[1],a[0]+a[2],a[1]+a[2]];
			var t1=false, t2=false;
			var pos=0;
			for(var k=0;k<e.length;k++){
					if(t1==false){
						if(b[0]==e[k][1]||b[1]==e[k][1]||b[2]==e[k][1]){
							t1=true;
							pos=k;
						}
					}else{
						if(k!=pos){
						if(b[0]==e[k][1]||b[1]==e[k][1]||b[2]==e[k][1]){
							for(var n=0;n<9;n++){
							if(board[lib[i][0]][n]==0){
							if(n!=e[j][0]&&n!=e[k][0]&&n!=e[pos][0]){
								if(t==false){
									if(candidates[lib[i][0]][n][b[0]]!=''){
										t=true
									}else if(candidates[lib[i][0]][n][b[1]]!=''){
										t=true
									}
								}
									candidates[lib[i][0]][n][b[0]-1]='';
									candidates[lib[i][0]][n][b[1]-1]='';
									candidatesJoin[lib[i][0]][n]=candidates[lib[i][0]][n].join('');
								}
							}
							}
							if(t){
						var s__ = 'naked triple ' + e[j][1] + ' @ row ' + (lib[i][0] + 1) + '\n';
						console.log(s__)
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }
						}
						}
						}
					}
				
			}
			}
		}
		}
		
		
// column
		e=[];t=false;
		for(var j=0;j<9;j++){
			var c=candidatesJoin[j][lib[i][0]];
			var l=c.length;
			if(l<4){
				if( l==2){
				for(var k=0;k<e.length;k++){
					if(c==e[k][1]){
						var b=c.split('')
						for(var n=0;n<9;n++){
							if(board[n][lib[i][0]]==0){
								if(n!=e[k][0]&&n!=j){
								if(t==false){
									if(candidates[n][lib[i][0]][b[0]]!=''){
										t=true
									}else if(candidates[n][lib[i][0]][b[1]]!=''){
										t=true
									}
								}
								
									candidates[n][lib[i][0]][b[0]-1]='';
									candidates[n][lib[i][0]][b[1]-1]='';
									candidatesJoin[n][lib[i][0]]=candidates[n][lib[i][0]].join('');
								}
							}
						}
						if(t){
						var s__ = 'naked pairs ' + c + ' @ column ' + (lib[i][0] + 1) + '\n';
						console.log(s__)
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }}
					}}
				}else if(l==3){
					
					}
				e.push([j,c])
			}
			
		}
		// column, triple
		if(t==false){
		for(var j=0;j<e.length;j++){
			if(e[j][1].length==3){
			var a=e[j][1].split('');
			var b=[a[0]+a[1],a[0]+a[2],a[1]+a[2]];
			var t1=false, t2=false;
			var pos=0;
			for(var k=0;k<e.length;k++){
					if(t1==false){
						if(b[0]==e[k][1]||b[1]==e[k][1]||b[2]==e[k][1]){
							t1=true;
							pos=k;
						}
					}else{
						if(k!=pos){
						if(b[0]==e[k][1]||b[1]==e[k][1]||b[2]==e[k][1]){
							for(var n=0;n<9;n++){
							if(board[n][lib[i][0]]==0){
							if(n!=e[j][0]&&n!=e[k][0]&&n!=e[pos][0]){
								if(t==false){
									if(candidates[n][lib[i][0]][b[0]]!=''){
										t=true
									}else if(candidates[n][lib[i][0]][b[1]]!=''){
										t=true
									}
								}
									candidates[n][lib[i][0]][b[0]-1]='';
									candidates[n][lib[i][0]][b[1]-1]='';
									candidatesJoin[n][lib[i][0]]=candidates[n][lib[i][0]].join('');
								}
							}
							}
							if(t){
						var s__ = 'naked triple ' + e[j][1] + ' @ row ' + (lib[i][0] + 1) + '\n';
						console.log(s__)
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }
						}
						}
						}
					}
				
			}
			}
		}
		}
		// block
		e=[];t=false;
		for(var j=0;j<9;j++){
			var x=block[i][j][0];
			var y=block[i][j][1];
			var c=candidatesJoin[x][y];
			var l=c.length;
			if(l<4){
			if(l==2){
				for(var k=0;k<e.length;k++){
					if(c==e[k][1]){
						var b=c.split('')
						for(var n=0;n<9;n++){
							var xn=block[i][n][0];
							var yn=block[i][n][1];
							if(board[x][y]==0){
								if(xn!=e[k][0]&&yn!=e[k][1]&&n!=j){
								if(t==false){
									if(candidates[xn][yn][b[0]-1]!=''){
										t=true
									}else if(candidates[xn][yn][b[1]-1]!=''){
										t=true
									}
								}
								
									candidates[xn][yn][b[0]-1]='';
									candidates[xn][yn][b[1]-1]='';
									candidatesJoin[xn][yn]=candidates[xn][yn].join('');
								}
							}
						}
						if(t){
						var s__ = 'naked pairs ' + c + ' @ block ' + (i + 1) + '\n';
						console.log(s__)
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }}
					}
				}}
				else if(l==3){
					
					}
				e.push([x,y,c])
			}
			
		}
		//block triple
if(t==false){
		for(var j=0;j<e.length;j++){
			if(e[j][2].length==3){
			var a=e[j][2].split('');
			var b=[a[0]+a[1],a[0]+a[2],a[1]+a[2]];
			var t1=false, t2=false;
			var pos=0;
			for(var k=0;k<e.length;k++){
					if(t1==false){
						if(b[0]==e[k][2]||b[1]==e[k][2]||b[2]==e[k][2]){
							t1=true;
							pos=k;
						}
					}else{
						if(k!=pos){
						if(b[0]==e[k][2]||b[1]==e[k][2]||b[2]==e[k][2]){
							for(var n=0;n<9;n++){
							var xn=block[i][n][0];
							var yn=block[i][n][1];
							if(board[x][y]==0){
								if(xn!=e[k][0]&&yn!=e[k][1]&&xn!=e[pos][0]&&yn!=e[pos][1]&&xn!=e[j][0]&&yn!=e[j][1]){
								if(t==false){
									if(candidates[xn][yn][b[0]-1]!=''){
										t=true
									}else if(candidates[xn][yn][b[1]-1]!=''){
										t=true
									}
								}
								
									candidates[xn][yn][b[0]-1]='';
									candidates[xn][yn][b[1]-1]='';
									candidatesJoin[xn][yn]=candidates[xn][yn].join('');
								}
							}
							}
							if(t){
						var s__ = 'naked triple ' + e[j][2] + ' @ block ' + (i + 1) + '\n';
						console.log(s__)
                        if (removings_nakedPairs.indexOf(s__) < 0) {
                            str += s__;
                            removings_nakedPairs += s__;
                        }
						}
						}
						}
					}
				
			}
			}
		}
		}

	}
for (i = 0; i < 9; i++) {
                console.log(candidatesJoin[i].join('; '))
            }
			console.log(str)
return str;

}
function RemovingCandidates(candidates, value, x, except, s) { // remove candidates from a row, column, block
    var str = except.join('');
	var b=true;
    switch (s) {
        case 'column':
            //console.log(value, x)
            for (var i = 0; i < 9; i++) {
			if(candidates[i][x][value]){
				//console.log('RemovingCandidates', i, x, candidatesJoin[i][x], value+1)
				}
                if (str.indexOf(i) < 0) {
					if(b&&candidates[i][x][value]){
					b=false;
					}
                    candidates[i][x][value] = '';
                    candidatesJoin[i][x] = candidates[i][x].join('');
					
                }
				
            }

            break;
		case 'row':
            //console.log(value, x)
            for (var i = 0; i < 9; i++) {
                if (str.indexOf(i) < 0) {
				if(b&&candidates[x][i][value]){
					b=false;
					}
                    candidates[x][i][value] = '';
                    candidatesJoin[x][i] = candidates[x][i].join('');
                }
            }

            break;
    }
	return b;
}

function check(board, value, pos, s) { // if a value is appeared at a row, column, block
    var k = false;
    switch (s) {
        case 'column':
            for (var i = 0; i < 9; i++) {
                if (board[i][pos] == value) {
                    k = true;
                }
            }
            break;
		case 'row':
            for (var i = 0; i < 9; i++) {
                if (board[pos][i] == value) {
                    k = true;
                }
            }
            break;
    }
    return k
}

function unique(s) { // remove duplicate chars in a string
    a = s.split('');
    b = ''
    for (var i = 0; i < a.length; i++) {
        if (b.indexOf(a[i]) < 0) {
            b += a[i]
        }
    }
    return b
}

function logInfo(info, value, x, y) {
    if (info.indexOf('cannot appear at') >= 0) {
		if(info.indexOf('column')>=0){
        return info + (value + 1) + ' (except for row ' + x + ')\n';
		}else if(info.indexOf('row')>=0){
		return info + (value + 1) + ' (except for column ' + x + ')\n';
		}
    } else {
        return info + value + ' @ row = ' + (x + 1) + ', column = ' + (y + 1) + '\n';
    }
}

</script>
<textarea id='in'>600802735702356940300407062100975024200183079079624003400560207067240300920738406</textarea>
<!--000010000510008000023700000000050010800931004096080500000800100900500820050060090--><!--22 steps-->
<!--800200047006005200000600009087000090009000500060090810500002000003900000210006008--><!--12 steps-->
<!--600000000020536000050010900130400000004020700000001045003060010400892070000000006--><!--17 steps-->
<!--096000100070619030321800069069000800240900613003000940930108006000790380002000590--><!--15 steps-->
<!--400270600798156234020840007237468951849531726561792843082015479070024300004087002--><!--naked pairs, 7 steps-->
<!--700000501203107000061000000800060000400500003005902800900041060000000140040800000-->
<!--704000501203157406561000000800060000400508603605902804900041060300000140140800000--><!--naked pairs-->
<!--5830102061740263002960507006390415027200000090052906003070620000052170063960000027-->
<!--300605000000030670010000080001062003002009050709000004000976000600000400020800007--><!--naked triple-->
<!--004000658201050039065003012428000065006805924050000087010200546642591873507000291--><!--naked triple-->
<!--004107900000000000100904008045000230000503000019000760500206009000000000007305600-->
<!--600802735702356940300407062100975024200183079079624003400560207067240300920738406--><!--naked triple-->

<br>
Unkown place is represented by <input type='text' id='u' value='0'><br>
<input type='button' class='btn' onclick='solve()' value='solve'>
<div id='out'></div>
</html>
